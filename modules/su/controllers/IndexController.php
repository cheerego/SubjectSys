<?php

namespace app\modules\su\controllers;

use app\models\Su;
use yii\helpers\Url;
use yii\web\Controller;

class IndexController extends Controller
{
    public $layout = 'sulayout';

    public function beforeAction($action)
    {
        /**
         *  通过session进行登录验证
         *  如果action的getUniqueId是'su/index/login'
         *  防止循环重定向,进行一个判断
         */
        if ($action->getUniqueId() !== 'su/index/login') {
            $session = \Yii::$app->session;
            $session->open();
            if ($session['yii']['type'] != 'su' || $session['yii']['islogin'] != 1) {
                return $this->redirect(Url::toRoute('index/login'));
            } else {
                return parent::beforeAction($action);
            }
        }

        return parent::beforeAction($action); // TODO: Change the autogenerated stub
    }

    public function actionIndex()
    {
        return $this->render('index');
    }

    public function actionLogin()
    {
        $this->layout = 'main';
        if (\Yii::$app->request->isPost) {
            $model = Su::findOne($_POST['Su']);
            if (empty($model)) {
                $model = new Su();
                return $this->render('login', ['model' => $model]);
            }
            $session = \Yii::$app->session;
            $session['yii'] = [
                'type' => 'su',
                'islogin' => 1,
                'name'=>'su'
            ];
            return $this->redirect(Url::toRoute('index/index'));
        } else {
            $model = new Su();
            return $this->render('login', ['model' => $model]);
        }

    }

    public function actionTeachercurd()
    {
        return $this->redirect(Url::toRoute('teachercurd/index'));
    }
}
